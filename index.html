<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Torreón Traffic Incidents</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
      color: #333;
    }
    h1 {
      text-align: center;
      margin: 20px 0;
    }
    #chart-container {
      width: 95%;
      margin: auto;
      overflow-x: auto;
      padding-bottom: 50px;
    }
    .bar {
      fill: #69b3a2;
    }
    .label {
      font-size: 12px;
      font-weight: 600;
      fill: #333;
    }
    .intersection-info {
      width: 95%;
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .intersection-info h2 {
      margin-top: 0;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: none;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <h1>Torreón Traffic Incidents</h1>
  <div id="chart-container">
    <div id="chart"></div>
  </div>

  <div class="intersection-info">
    <h2 id="intersection-name">Hover over a bar</h2>
    <p id="total-incidents"></p>
    <p id="semaforizado-status"></p>
    <iframe id="street-view" src=""></iframe>
  </div>

  <script>
    const margin = {top: 20, right: 20, bottom: 250, left: 60};
    const width = 1200 - margin.left - margin.right;
    const height = 600 - margin.top - margin.bottom;

    const svg = d3.select("#chart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Function to wrap text
    function wrap(text, width) {
      text.each(function () {
        var text = d3.select(this),
            words = text.text().split(/\s+/).reverse(),
            word,
            line = [],
            lineHeight = 1.1,
            y = text.attr("y"),
            dy = parseFloat(text.attr("dy")),
            tspan = text.text(null)
                        .append("tspan")
                        .attr("x", 0)
                        .attr("y", y)
                        .attr("dy", dy + "em");
        while (word = words.pop()) {
          line.push(word);
          tspan.text(line.join(" "));
          if (tspan.node().getComputedTextLength() > width) {
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            tspan = text.append("tspan")
                        .attr("x", 0)
                        .attr("y", y)
                        .attr("dy", ++lineHeight * 1.1 + "em")
                        .text(word);
          }
        }
      });
    }

    Promise.all([
      d3.csv("https://paco-stack-crimson.github.io/torreon-incidents/incidentes.csv"),
      d3.json("https://paco-stack-crimson.github.io/torreon-incidents/datos.json")
    ]).then(function(files) {
      const trafficData = files[0];
      const intersectionsData = files[1].intersections;

      trafficData.forEach(d => d.total_incidentes = +d.total_incidentes || 0);

      const x = d3.scaleBand()
        .domain(trafficData.map(d => d.Crucero))
        .range([0, width])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([0, d3.max(trafficData, d => d.total_incidentes)]).nice()
        .range([height, 0]);

      // X axis
      const xAxis = svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));

      xAxis.selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end")
        .style("font-size", "12px")
        .call(wrap, x.bandwidth());

      // Y axis
      svg.append("g")
        .call(d3.axisLeft(y));

      // Bars
      svg.selectAll(".bar")
        .data(trafficData)
        .enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.Crucero))
        .attr("y", d => y(d.total_incidentes))
        .attr("width", x.bandwidth())
        .attr("height", d => height - y(d.total_incidentes))
        .on("mouseover", handleMouseOver)
        .on("mouseout", handleMouseOut);

      // Labels on bars
      svg.selectAll(".label")
        .data(trafficData)
        .enter()
        .append("text")
        .attr("class", "label")
        .attr("x", d => x(d.Crucero) + x.bandwidth()/2)
        .attr("y", d => y(d.total_incidentes) - 5)
        .attr("text-anchor", "middle")
        .text(d => d.total_incidentes);

      function handleMouseOver(event, d) {
        const matching = intersectionsData.find(i => i.cruce === d.Crucero);
        if (matching) {
          d3.select("#intersection-name").text(matching.cruce);
          d3.select("#total-incidents").text("Total Incidents: " + matching.incidents);
          d3.select("#semaforizado-status").text("Traffic Light: " + matching.semaforizado);

          const streetUrl = `https://www.google.com/maps/embed/v1/streetview?key=YOUR_API_KEY&location=${matching.latitude},${matching.longitude}&heading=210&pitch=10&fov=80`;
          d3.select("#street-view").attr("src", streetUrl);
        }
      }

      function handleMouseOut(event, d) {
        d3.select("#intersection-name").text("Hover over a bar");
        d3.select("#total-incidents").text("");
        d3.select("#semaforizado-status").text("");
        d3.select("#street-view").attr("src", "");
      }

    }).catch(error => console.error(error));
  </script>
</body>
</html>
