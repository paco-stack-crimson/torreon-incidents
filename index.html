<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Google Maps JS API -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
</script>

<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; color: #333; }
h1 { color: #004d99; font-size: 2.5em; border-bottom: 2px solid #ccc; padding-bottom: 10px; text-align: center; }
#container { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; }
#chart-container { flex: 2; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
#panel { flex: 1; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 0.9em; }
#map-streetview-row { display: flex; gap: 20px; margin-top: 20px; justify-content: center; max-width: 1200px; margin: 20px auto; }
#map, #streetview { flex: 1; height: 400px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.bar { fill: #004d99; cursor: pointer; transition: fill 0.2s; }
.bar:hover { fill: #ff6347; }
.axis text { font-size: 12px; }
</style>
</head>
<body>

<h1>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</h1>

<div id="container">
  <div id="chart-container"></div>
  <div id="panel">
    <h3 id="panel-title">Información del Crucero</h3>
    <p id="panel-totales">Total de Incidentes: </p>
    <p id="panel-semaforizado">Semaforizado: </p>
  </div>
</div>

<div id="map-streetview-row">
  <div id="map"></div>
  <div id="streetview"></div>
</div>

<script>
let map;
let streetView;
let markers = [];

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 25.55, lng: -103.4 },
    zoom: 12
  });

  streetView = new google.maps.StreetViewPanorama(
    document.getElementById('streetview'),
    {
      position: { lat: 25.55, lng: -103.4 },
      pov: { heading: 0, pitch: 0 },
      zoom: 1
    }
  );
  map.setStreetView(streetView);

  renderChart();
}

function renderChart() {
  d3.select("#chart-container").selectAll("*").remove();

  Promise.all([
    d3.csv("https://paco-stack-crimson.github.io/torreon-incidents/Incidentes.csv"),
    d3.json("https://paco-stack-crimson.github.io/torreon-incidents/datos.json")
  ]).then(([csvData, jsonData]) => {

    const INCIDENTS_KEY = "total_incidentes";

    // Merge CSV + JSON
    const jsonLookup = {};
    jsonData.intersections.forEach(i => jsonLookup[i.cruce] = i);
    const mergedData = csvData.map(d => {
      const extra = jsonLookup[d.Crucero] || {};
      return {
        Crucero: d.Crucero,
        total_incidentes: +d[INCIDENTS_KEY] || extra.incidents || 0,
        semaforizado: extra.semaforizado || "",
        latitude: extra.latitude || null,
        longitude: extra.longitude || null
      };
    });

    // Clear old markers
    markers.forEach(m => m.setMap(null));
    markers = [];

    // Chart dimensions
    const margin = {top: 20, right: 20, bottom: 20, left: 40};
    const width = 600 - margin.left - margin.right;
    const height = 400 - margin.top - margin.bottom;

    const svg = d3.select("#chart-container")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleBand()
      .domain(mergedData.map(d=>d.Crucero))
      .range([0, width])
      .padding(0.2);

    const y = d3.scaleLinear()
      .domain([0, d3.max(mergedData, d=>d.total_incidentes)]).nice()
      .range([height, 0]);

    svg.append("g")
      .call(d3.axisLeft(y));

    // Bars
    svg.selectAll(".bar")
      .data(mergedData)
      .enter()
      .append("rect")
        .attr("class","bar")
        .attr("x", d=>x(d.Crucero))
        .attr("y", d=>y(d.total_incidentes))
        .attr("width", x.bandwidth())
        .attr("height", d=>height - y(d.total_incidentes))
        .on("mouseover", (event,d)=>{
          // Update panel
          d3.select("#panel-totales").text("Total de Incidentes: " + d.total_incidentes);
          d3.select("#panel-semaforizado").text("Semaforizado: " + d.semaforizado);

          // Update map center and marker
          if(d.latitude && d.longitude){
            map.setCenter({ lat: +d.latitude, lng: +d.longitude });
            map.setZoom(15);

            // Clear previous markers
            markers.forEach(m=>m.setMap(null));
            markers = [];

            const marker = new google.maps.Marker({
              position: { lat: +d.latitude, lng: +d.longitude },
              map: map,
              title: d.Crucero
            });
            markers.push(marker);

            // Update Street View
            streetView.setPosition({ lat: +d.latitude, lng: +d.longitude });
            streetView.setPov({ heading: 0, pitch: 0 });
          }
        });
  }).catch(error=>{
    console.error("Error loading data:", error);
    d3.select("#chart-container").html("<p style='color:red;'>Error loading data.</p>");
  });
}
</script>

</body>
</html>
