<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
/* --- Chart & Panel Styles --- */
body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f4f4f4; color:#333; }
h1 { color:#004d99; font-size:2.5em; border-bottom:2px solid #ccc; padding-bottom:10px; text-align:center; }
#chart-panel-container { display:flex; justify-content:center; gap:20px; margin-top:20px; }
#chart-container { flex:1; max-width:800px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
#info-panel { width:200px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); font-size:0.9em; }
.bar { fill:#004d99; cursor:pointer; transition: fill 0.2s; }
.bar:hover { fill:#ff6347; }
#map-streetview-row { display:flex; gap:20px; margin-top:20px; justify-content:center; }
#map, #streetview { flex:1; height:400px; border-radius:10px; }
</style>
</head>
<body>

<h1>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</h1>

<!-- Chart + Info Panel -->
<div id="chart-panel-container">
  <div id="chart-container"></div>
  <div id="info-panel">
    <h3>Información</h3>
    <p id="panel-cruce">Cruce: -</p>
    <p id="panel-total">Totales: -</p>
    <p id="panel-semaforizado">Semaforizado: -</p>
  </div>
</div>

<!-- Google Maps + Street View -->
<div id="map-streetview-row">
  <div id="map"></div>
  <div id="streetview"></div>
</div>

<script>
let map, streetView;

// --- INIT GOOGLE MAPS ---
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 25.55, lng: -103.4 },
    zoom: 12
  });

  streetView = new google.maps.StreetViewPanorama(
    document.getElementById('streetview'),
    { position: { lat: 25.55, lng: -103.4 }, pov: { heading: 0, pitch: 0 }, zoom: 1 }
  );

  map.setStreetView(streetView);

  renderChart(); // call chart rendering
}

// --- D3 CHART ---
function renderChart() {
  const margin = {top:20,right:20,bottom:40,left:60};
  const width = 800 - margin.left - margin.right;
  const height = 400 - margin.top - margin.bottom;

  const svg = d3.select("#chart-container").selectAll("*").remove();
  const svg2 = d3.select("#chart-container")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  Promise.all([
    d3.csv("https://paco-stack-crimson.github.io/torreon-incidents/incidentes.csv"),
    d3.json("https://paco-stack-crimson.github.io/torreon-incidents/datos.json")
  ]).then(([csvData, jsonData]) => {

    const jsonLookup = {};
    jsonData.intersections.forEach(d => { jsonLookup[d.cruce] = d; });

    const mergedData = csvData.map(d => {
      const extra = jsonLookup[d.Crucero] || {};
      return {
        Crucero: d.Crucero,
        total_incidentes: +d.total_incidentes || extra.incidents || 0,
        semaforizado: extra.semaforizado || "No",
        latitude: extra.latitude || 25.55,
        longitude: extra.longitude || -103.4,
        streetView: extra.streetView || ""
      };
    });

    const x = d3.scaleBand()
      .domain(mergedData.map(d=>d.Crucero))
      .range([0,width])
      .padding(0.2);

    const y = d3.scaleLinear()
      .domain([0,d3.max(mergedData,d=>d.total_incidentes)]).nice()
      .range([height,0]);

    svg2.append("g")
      .attr("transform",`translate(0,${height})`)
      .call(d3.axisBottom(x).tickFormat(""));

    svg2.append("g")
      .call(d3.axisLeft(y));

    svg2.selectAll(".bar")
      .data(mergedData)
      .enter()
      .append("rect")
      .attr("class","bar")
      .attr("x",d=>x(d.Crucero))
      .attr("y",d=>y(d.total_incidentes))
      .attr("width",x.bandwidth())
      .attr("height",d=>height - y(d.total_incidentes))
      .on("mouseover",(event,d)=>{
        d3.select("#panel-cruce").text(`Cruce: ${d.Crucero}`);
        d3.select("#panel-total").text(`Totales: ${d.total_incidentes}`);
        d3.select("#panel-semaforizado").text(`Semaforizado: ${d.semaforizado}`);

        // Update Google Maps marker + center
        const pos = {lat: +d.latitude, lng: +d.longitude};
        map.setCenter(pos);
        map.setZoom(15);
        streetView.setPosition(pos);
      });

    // Optional: add labels on top
    svg2.selectAll(".label")
      .data(mergedData)
      .enter()
      .append("text")
      .attr("x", d=>x(d.Crucero)+x.bandwidth()/2)
      .attr("y", d=>y(d.total_incidentes)-5)
      .attr("text-anchor","middle")
      .style("font-size","10px")
      .text(d=>d.total_incidentes);
  }).catch(err => console.error("Error loading data", err));
}
</script>

<!-- Google Maps API -->
<script async
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDf8skGR8RqBL3eVy1i8Euk6S424fvEsco&callback=initMap">
</script>

</body>
</html>
