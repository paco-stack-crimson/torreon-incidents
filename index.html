<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f4f4f4; color:#333; text-align:center;}
h1 { color:#004d99; font-size:2.5em; border-bottom:2px solid #ccc; padding-bottom:10px; }

#chart-panel-container { display:flex; gap:20px; justify-content:center; align-items:flex-start; }
#chart-container { flex:2; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); overflow-x:auto; }
#info-panel { flex:1; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:left; font-size:0.9em; }

.bar { fill:#004d99; cursor:pointer; transition: fill 0.2s;}
.bar:hover { fill:#ff6347;}
.x-axis text, .y-axis text { font-size:12px; }

#map-streetview-row { display:flex; gap:20px; margin-top:20px; justify-content:center; }
#map-container, #streetview-container { flex:1; height:400px; border-radius:12px; overflow:hidden; }
</style>
</head>

<body>
<h1>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</h1>

<!-- Graph + Hover Panel -->
<div id="chart-panel-container">
  <div id="chart-container"></div>
  <div id="info-panel">
    <h3>Información del Cruce</h3>
    <p><strong>Totales:</strong> <span id="total-incidents">-</span></p>
    <p><strong>Semaforizado:</strong> <span id="semaforizado-status">-</span></p>
  </div>
</div>

<!-- Google Map + Street View Row -->
<div id="map-streetview-row">
  <div id="map-container">
    <div id="google-map"></div>
  </div>
  <div id="streetview-container">
    <div id="google-streetview"></div>
  </div>
</div>

<!-- Script -->
<script>
const API_KEY = "YOUR_API_KEY"; // <-- Replace with your valid key

// Chart rendering
function renderChart() {
    d3.select("#chart-container").selectAll("*").remove();

    Promise.all([
      d3.csv("https://paco-stack-crimson.github.io/torreon-incidents/incidentes.csv"),
      d3.json("https://paco-stack-crimson.github.io/torreon-incidents/datos.json")
    ]).then(([trafficData, intersectionsData]) => {

        const INCIDENTS_KEY = "total_incidentes";

        trafficData.forEach(d => d[INCIDENTS_KEY] = +d[INCIDENTS_KEY]);

        const margin = {top:20,right:20,bottom:50,left:60};
        const containerWidth = document.getElementById("chart-container").clientWidth;
        const totalChartHeight = 400;
        const height = totalChartHeight - margin.top - margin.bottom;
        const minBarWidth = 35;
        const chartWidth = Math.max(containerWidth - margin.left - margin.right, trafficData.length * minBarWidth);

        const svg = d3.select("#chart-container")
          .append("svg")
          .attr("width", chartWidth + margin.left + margin.right)
          .attr("height", totalChartHeight)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleBand()
          .domain(trafficData.map(d=>d.Crucero))
          .range([0, chartWidth])
          .padding(0.2);

        const y = d3.scaleLinear()
          .domain([0, d3.max(trafficData, d => d[INCIDENTS_KEY])]).nice()
          .range([height,0]);

        svg.append("g").call(d3.axisLeft(y));
        // Remove x-axis (no Crucero labels)
        // svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));

        // Bars + Hover
        svg.selectAll(".bar")
          .data(trafficData)
          .enter()
          .append("rect")
          .attr("class","bar")
          .attr("x", d=>x(d.Crucero))
          .attr("y", d=>y(d[INCIDENTS_KEY]))
          .attr("width", x.bandwidth())
          .attr("height", d=>height - y(d[INCIDENTS_KEY]))
          .on("mouseover", (event,d)=>{
              const match = intersectionsData.intersections.find(i=>i.cruce===d.Crucero);
              if(match){
                  document.getElementById("total-incidents").innerText = match.incidents;
                  document.getElementById("semaforizado-status").innerText = match.semaforizado;

                  // Update Street View
                  const svFrame = document.getElementById("google-streetview");
                  svFrame.innerHTML = `<iframe width="100%" height="100%" frameborder="0" style="border:0"
                    allowfullscreen
                    src="https://www.google.com/maps/embed/v1/streetview?key=${API_KEY}&location=${match.latitude},${match.longitude}"></iframe>`;

                  // Update Map
                  const map = window.mapInstance;
                  const position = { lat: match.latitude, lng: match.longitude };
                  map.setCenter(position);
                  map.setZoom(14);

                  // Place marker
                  if(window.currentMarker) window.currentMarker.setMap(null);
                  window.currentMarker = new google.maps.Marker({
                      position,
                      map: map,
                      title: match.cruce
                  });
              }
          })
          .on("mouseout", ()=>{
              // Optional: clear info panel
          });

    }).catch(error=>{
        console.error("Error loading data:", error);
        d3.select("#chart-container").html("<p style='color:red;'>Error loading data. Check console.</p>");
    });
}

// Google Map initialization
function initMap() {
    const map = new google.maps.Map(document.getElementById("google-map"), {
        center: { lat: 25.5428443, lng: -103.4067861 },
        zoom: 12
    });
    window.mapInstance = map;
}

// Initial render
renderChart();
</script>

<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>

</body>
</html>
