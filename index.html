<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f4f4f4; color:#333; text-align:center; }
h1 { color:#004d99; font-size:2.5em; border-bottom:2px solid #ccc; padding-bottom:10px; }
#chart-panel-row { display:flex; gap:20px; margin-top:20px; justify-content:center; }
#chart-container { flex:2; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); overflow-x:auto; }
#info-panel { flex:1; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); font-size:0.9em; text-align:left; }
.bar { fill:#004d99; cursor:pointer; transition: fill 0.2s; }
.bar:hover { fill:#ff6347; }
#map-streetview-row { display:flex; gap:20px; margin-top:20px; justify-content:center; }
#map-container, #streetview-container { flex:1; height:400px; border-radius:12px; overflow:hidden; }
</style>
</head>
<body>

<h1>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</h1>

<!-- Chart + Info Panel -->
<div id="chart-panel-row">
  <div id="chart-container"></div>
  <div id="info-panel">
    <h3 id="intersection-name">Seleccione un crucero</h3>
    <p id="total-incidents">Total de Incidentes: -</p>
    <p id="semaforizado-status">Semaforizado: -</p>
  </div>
</div>

<!-- Map + Street View row -->
<div id="map-streetview-row">
  <div id="map-container">
    <iframe
      id="google-map"
      width="100%"
      height="100%"
      frameborder="0"
      style="border:0;"
      allowfullscreen
      src="https://www.google.com/maps/embed/v1/view?key=YOUR_API_KEY&center=25.5428443,-103.4067861&zoom=14">
    </iframe>
  </div>

  <div id="streetview-container">
    <iframe
      id="google-streetview"
      width="100%"
      height="100%"
      frameborder="0"
      style="border:0;"
      allowfullscreen
      src="https://www.google.com/maps/embed/v1/streetview?key=YOUR_API_KEY&location=25.5428443,-103.4067861">
    </iframe>
  </div>
</div>

<script>
const API_KEY = "AIzaSyAQCeGzfHnjRD_LqC02dbti8G50AEbnKTs"; // <-- Replace this with your actual Google Maps API key

Promise.all([
  d3.csv("incidentes.csv"),
  d3.json("datos.json")
]).then(([trafficData, intersectionsData]) => {
  const intersections = intersectionsData.intersections;

  // Convert numeric fields
  trafficData.forEach(d => d.total_incidentes = +d.total_incidentes);

  // Chart dimensions
  const margin = {top:20,right:20,bottom:80,left:60};
  const chartWidth = 700;
  const chartHeight = 400;
  const width = chartWidth - margin.left - margin.right;
  const height = chartHeight - margin.top - margin.bottom;

  const svg = d3.select("#chart-container")
    .append("svg")
    .attr("width", chartWidth)
    .attr("height", chartHeight)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  const x = d3.scaleBand()
    .domain(trafficData.map(d => d.Crucero))
    .range([0,width])
    .padding(0.2);

  const y = d3.scaleLinear()
    .domain([0,d3.max(trafficData,d=>d.total_incidentes)]).nice()
    .range([height,0]);

  svg.append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x))
    .selectAll("text")
    .attr("transform","rotate(-60)")
    .style("text-anchor","end");

  svg.append("g").call(d3.axisLeft(y));

  // Bars
  svg.selectAll(".bar")
    .data(trafficData)
    .enter()
    .append("rect")
      .attr("class","bar")
      .attr("x", d => x(d.Crucero))
      .attr("y", d => y(d.total_incidentes))
      .attr("width", x.bandwidth())
      .attr("height", d => height - y(d.total_incidentes))
      .on("mouseover", (event,d)=>{
        const match = intersections.find(i=>i.cruce === d.Crucero);
        if(match){
          // Update info panel
          d3.select("#intersection-name").text(match.cruce);
          d3.select("#total-incidents").text("Total de Incidentes: " + match.incidents);
          d3.select("#semaforizado-status").text("Semaforizado: " + match.semaforizado);

          // Update Google Maps iframe
          d3.select("#google-map")
            .attr("src", `https://www.google.com/maps/embed/v1/view?key=${API_KEY}&center=${match.latitude},${match.longitude}&zoom=14`);

          d3.select("#google-streetview")
            .attr("src", `https://www.google.com/maps/embed/v1/streetview?key=${API_KEY}&location=${match.latitude},${match.longitude}`);
        }
      });
}).catch(err => {
  console.error("Error loading data:", err);
  d3.select("#chart-container").html("<p style='color:red;'>Error loading data. Check the console for details.</p>");
});
</script>

</body>
</html>
