<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f4f4f4; color:#333; text-align:center; }
h1 { color:#004d99; font-size:2.5em; border-bottom:2px solid #ccc; padding-bottom:10px; }
#chart-panel { display:flex; gap:20px; justify-content:center; flex-wrap:wrap; }
#chart-container { flex:1; min-width:600px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
#info-panel { flex:0 0 250px; background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:left; }
#map-streetview-row { display:flex; gap:20px; justify-content:center; margin-top:20px; flex-wrap:wrap; }
#map, #streetview { flex:1; min-width:300px; height:400px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
.bar { fill:#004d99; cursor:pointer; transition: fill 0.2s; }
.bar:hover { fill:#ff6347; }
</style>
</head>
<body>

<h1>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</h1>

<div id="chart-panel">
  <div id="chart-container"></div>
  <div id="info-panel">
    <h3 id="hover-cruce">Cruce info</h3>
    <p id="hover-total">Total de incidentes:</p>
    <p id="hover-semaforizado">Semaforizado:</p>
  </div>
</div>

<div id="map-streetview-row">
  <div id="map"></div>
  <div id="streetview"></div>
</div>

<script>
const API_KEY = "YOUR_API_KEY";

// Load CSV + JSON
Promise.all([
  d3.csv("incidentes.csv"),
  d3.json("datos.json")
]).then(([csvData, jsonData]) => {

  // Build JSON lookup
  const jsonLookup = {};
  jsonData.intersections.forEach(i => jsonLookup[i.cruce] = i);

  const mergedData = csvData.map(d => {
    const extra = jsonLookup[d.Crucero] || {};
    return {
      Crucero: d.Crucero,
      total_incidentes: +d.total_incidentes || extra.incidents || 0,
      semaforizado: extra.semaforizado || "No",
      latitude: extra.latitude || null,
      longitude: extra.longitude || null
    };
  });

  // Chart dimensions
  const margin = {top:20,right:20,bottom:50,left:60};
  const width = 600 - margin.left - margin.right;
  const height = 400 - margin.top - margin.bottom;

  const svg = d3.select("#chart-container").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  // Scales
  const x = d3.scaleBand().domain(mergedData.map(d=>d.Crucero)).range([0,width]).padding(0.2);
  const y = d3.scaleLinear().domain([0,d3.max(mergedData,d=>d.total_incidentes)]).range([height,0]).nice();

  // Bars
  svg.selectAll(".bar").data(mergedData).enter().append("rect")
    .attr("class","bar")
    .attr("x",d=>x(d.Crucero))
    .attr("y",d=>y(d.total_incidentes))
    .attr("width",x.bandwidth())
    .attr("height",d=>height - y(d.total_incidentes))
    .on("mouseover",(event,d)=>{
      document.getElementById("hover-cruce").textContent = d.Crucero;
      document.getElementById("hover-total").textContent = "Total de incidentes: " + d.total_incidentes;
      document.getElementById("hover-semaforizado").textContent = "Semaforizado: " + d.semaforizado;

      if(d.latitude && d.longitude){
        // Update street view
        streetView.setPosition({lat:+d.latitude,lng:+d.longitude});
        // Pan map to marker
        map.setCenter({lat:+d.latitude,lng:+d.longitude});
      }
    });

  // Y-axis
  svg.append("g").call(d3.axisLeft(y));
  // X-axis removed

  // Initialize Google Maps
  window.initMap = function(){
    map = new google.maps.Map(document.getElementById("map"), {
      center: {lat:25.5428443,lng:-103.4067861},
      zoom: 12
    });

    streetView = new google.maps.StreetViewPanorama(
      document.getElementById("streetview"),
      {position: {lat:25.5428443,lng:-103.4067861}, pov:{heading:165,pitch:0}, zoom:1}
    );

    map.setStreetView(streetView);

    // Add markers
    mergedData.forEach(d=>{
      if(d.latitude && d.longitude){
        new google.maps.Marker({
          position:{lat:+d.latitude,lng:+d.longitude},
          map: map,
          title: d.Crucero
        });
      }
    });
  };
}).catch(err=>{
  console.error("Error loading data", err);
});
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>

</body>
</html>
