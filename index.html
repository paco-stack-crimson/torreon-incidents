<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</title>
<meta name="viewport" content="width=1260">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { 
    font-family: Arial, sans-serif; 
    margin:0; 
    padding:20px; 
    background:#f4f4f4; 
    color:#333; 
    text-align:center;
}
h1 { 
    color:#004d99; 
    font-size:2.5em; 
    border-bottom:2px solid #ccc; 
    padding-bottom:10px; 
}
#chart-container { 
    width:90%; 
    max-width:1200px;
    margin:20px auto; 
    overflow-x:auto; 
    background:#fff; 
    padding:20px; 
    border-radius:12px; 
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
svg { display:block; }
.bar { 
    fill:#004d99; 
    cursor:pointer; 
    transition: fill 0.2s;
}
.bar:hover { fill:#ff6347; }
.panel {
    display:inline-block;
    vertical-align:top;
    text-align:left;
    margin-left:20px;
    width:250px;
}
.panel h3 { margin:0 0 5px 0; color:#004d99; }
.panel p { margin:3px 0; }

/* Map + Street View row styling */
#map-streetview-row {
    display:flex;
    gap:20px;
    margin-top:20px;
    justify-content:center;
    flex-wrap: wrap;
}
.map-box, .streetview-box {
    flex:1 1 400px; /* Grow but maintain min width */
    height:400px;
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    background:#fff;
}
.map-box iframe, .streetview-box iframe {
    width:100%;
    height:100%;
    border:0;
}
</style>
</head>
<body>

<h1>CRUCES MÁS CONFLICTIVOS DE TORREÓN 2018-2025</h1>
<div style="display:flex; justify-content:center; flex-wrap: wrap;">
    <div id="chart-container"></div>
    <div class="panel">
        <h3 id="hover-crucero">Crucero</h3>
        <p id="hover-total">Total: </p>
        <p id="hover-semaforizado">Semaforizado: </p>
    </div>
</div>

<!-- Map + Street View row -->
<div id="map-streetview-row">
  <div class="map-box">
    <iframe
      id="google-map"
      allowfullscreen
      src="https://www.google.com/maps/embed/v1/view?key=YOUR_API_KEY&center=25.5428443,-103.4067861&zoom=14">
    </iframe>
  </div>
  <div class="streetview-box">
    <iframe
      id="google-streetview"
      allowfullscreen
      src="https://www.google.com/maps/embed/v1/streetview?key=YOUR_API_KEY&location=25.5428443,-103.4067861">
    </iframe>
  </div>
</div>

<script>
const API_KEY = "YOUR_API_KEY"; // Google Maps API Key

function renderChart() {
    d3.select("#chart-container").selectAll("*").remove();

    Promise.all([
      d3.csv("incidentes.csv"),
      d3.json("datos.json")
    ]).then(([trafficData, intersectionsData]) => {

        const INCIDENTS_KEY = "total_incidentes"; // CSV column

        trafficData = trafficData.filter(d => d.Crucero && d[INCIDENTS_KEY] !== undefined);
        trafficData.forEach(d => d[INCIDENTS_KEY] = +d[INCIDENTS_KEY]);

        const margin = {top:20,right:20,bottom:60,left:60};
        const containerWidth = document.getElementById("chart-container").clientWidth;
        const totalChartHeight = 500;
        const height = totalChartHeight - margin.top - margin.bottom;

        const minBarWidth = 35;
        const chartWidth = Math.max(containerWidth - margin.left - margin.right, trafficData.length * minBarWidth);

        const svg = d3.select("#chart-container")
          .append("svg")
          .attr("width", chartWidth + margin.left + margin.right)
          .attr("height", totalChartHeight)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        // SCALES
        const x = d3.scaleBand()
          .domain(trafficData.map(d=>d.Crucero))
          .range([0, chartWidth])
          .padding(0.2);

        const y = d3.scaleLinear()
          .domain([0, d3.max(trafficData, d => d[INCIDENTS_KEY])]).nice()
          .range([height,0]);

        // AXES
        svg.append("g")
          .attr("class", "y-axis")
          .call(d3.axisLeft(y));

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Total de Incidentes");

        // BARS
        svg.selectAll(".bar")
          .data(trafficData)
          .enter()
          .append("rect")
            .attr("class","bar")
            .attr("x", d=>x(d.Crucero))
            .attr("y", d=>y(d[INCIDENTS_KEY]))
            .attr("width", x.bandwidth())
            .attr("height", d=>height - y(d[INCIDENTS_KEY]))
            .on("mouseover", (event,d)=>{
                const match = intersectionsData.find(i=>i.cruce===d.Crucero);
                if(match){
                    document.getElementById("hover-crucero").textContent = match.cruce;
                    document.getElementById("hover-total").textContent = "Total: " + match.incidents;
                    document.getElementById("hover-semaforizado").textContent = "Semaforizado: " + match.semaforizado;

                    const streetViewUrl = `https://www.google.com/maps/embed/v1/streetview?key=${API_KEY}&location=${match.latitude},${match.longitude}`;
                    document.getElementById("google-streetview").src = streetViewUrl;

                    const mapUrl = `https://www.google.com/maps/embed/v1/view?key=${API_KEY}&center=${match.latitude},${match.longitude}&zoom=14`;
                    document.getElementById("google-map").src = mapUrl;
                }
            });
    }).catch(function(error) {
        console.error("Error cargando los datos:", error);
        d3.select("#chart-container").html("<p style='color:red;'>Error cargando los datos. Revisa la consola.</p>");
    });
}

renderChart();
window.addEventListener("resize", renderChart);
</script>

</body>
</html>
