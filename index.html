<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CRUCEROS MÁS CONFLICTIVOS DE TORREÓN 2018-2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { font-family: Verdana, sans-serif; margin:0; padding:20px; background:#white; color:#black; text-align:center; }
h1 { color:#black; font-size:2.5em; padding-bottom:10px; }
#chart-container { width:90%; max-width:1200px; margin:20px auto; overflow-x:auto; background:#fff; padding:20px; border-radius:12px;}
svg { display:block; }
.bar { fill:#red; cursor:pointer; transition: fill 0.2s; }
.bar:hover { fill:#ff6347; }
.tooltip { position:absolute; background:#fff; padding:10px; border:1px solid #ccc; border-radius:5px;}
.tooltip img { max-width:300px; height:auto; display:block; margin-top:5px; }
.panel { width:300px; padding:10px; border-radius:10px; background:#fff; margin-left:20px; text-align:left; }
#main-row { display:flex; justify-content:center; align-items:flex-start; gap:20px; }
#map-streetview-row { display:flex; justify-content:center; gap:20px; margin-top:20px; }
#map-container, #streetview-container { flex:1; height:400px; }
</style>
</head>
<body>

<h1>CRUCEROS MÁS CONFLICTIVOS DE TORREÓN 2018-2025</h1>

<!-- Chart + Panel -->
<div id="main-row">
  <div id="chart-container"></div>
  <div class="panel" id="info-panel">
    <p><strong>CRUCERO:</strong> <span id="intersection-name">Hover a bar</span></p>
    <p><strong>TOTAL:</strong> <span id="total-incidents">-</span></p>
    <p><strong>SEMAFORIZADO:</strong> <span id="semaforizado-status">-</span></p>
  </div>
</div>

<!-- Maps + Street View -->
<div id="map-streetview-row">
  <div id="map-container"></div>
  <div id="streetview-container"></div>
</div>

<script>
const API_KEY = "AIzaSyDf8skGR8RqBL3eVy1i8Euk6S424fvEsco"; // <-- replace with your key

// D3 Chart
function renderChart() {
  d3.select("#chart-container").selectAll("*").remove();

  Promise.all([
    d3.csv("https://paco-stack-crimson.github.io/torreon-incidents/incidentes.csv"),
    d3.json("https://paco-stack-crimson.github.io/torreon-incidents/datos.json")
  ]).then(([csvData, jsonData]) => {
    // Merge CSV + JSON
    const jsonLookup = {};
    jsonData.intersections.forEach(i => jsonLookup[i.cruce] = i);

    const mergedData = csvData.map(d => {
      const extra = jsonLookup[d.Crucero] || {};
      return {
        Crucero: d.Crucero,
        total_incidentes: +d.total_incidentes || extra.incidents || 0,
        semaforizado: extra.semaforizado || "",
        latitude: extra.latitude || null,
        longitude: extra.longitude || null
      };
    });

    // Chart dimensions
    const margin = {top:20,right:20,bottom:20,left:60};
    const containerWidth = document.getElementById("chart-container").clientWidth;
    const totalChartHeight = 400;
    const height = totalChartHeight - margin.top - margin.bottom;
    const minBarWidth = 30;
    const chartWidth = Math.max(containerWidth - margin.left - margin.right, mergedData.length * minBarWidth);

    const svg = d3.select("#chart-container")
      .append("svg")
      .attr("width", chartWidth + margin.left + margin.right)
      .attr("height", totalChartHeight)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Scales
    const x = d3.scaleBand()
      .domain(mergedData.map(d => d.Crucero))
      .range([0, chartWidth])
      .padding(0.2);

    const y = d3.scaleLinear()
      .domain([0, d3.max(mergedData, d => d.total_incidentes)]).nice()
      .range([height,0]);

    // Axes (no labels at bottom)
    svg.append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).tickFormat(""));

    svg.append("g").call(d3.axisLeft(y));

    // Bars + hover
    svg.selectAll(".bar")
      .data(mergedData)
      .enter()
      .append("rect")
      .attr("class","bar")
      .attr("x", d => x(d.Crucero))
      .attr("y", d => y(d.total_incidentes))
      .attr("width", x.bandwidth())
      .attr("height", d => height - y(d.total_incidentes))
      .on("mouseover", (event,d)=>{
        d3.select("#intersection-name").text(d.Crucero);
        d3.select("#total-incidents").text(d.total_incidentes);
        d3.select("#semaforizado-status").text(d.semaforizado);

        if(d.latitude && d.longitude){
          updateMaps(d.latitude, d.longitude);
        }
      });
    
  }).catch(err => console.error("Error loading data:", err));
}

renderChart();
window.addEventListener("resize", renderChart);

// Google Maps + Street View
let map, streetView;
function initMaps() {
  const center = {lat: 25.5428443, lng: -103.4067861};

  map = new google.maps.Map(document.getElementById("map-container"), {
    zoom: 12,
    center: center
  });

  streetView = new google.maps.StreetViewPanorama(
    document.getElementById("streetview-container"), {
      position: center,
      pov: {heading: 165, pitch: 0},
      zoom: 1
    }
  );

  map.setStreetView(streetView);
}

function updateMaps(lat, lng){
  const pos = {lat:+lat, lng:+lng};
  map.setCenter(pos);

  new google.maps.Marker({
    position: pos,
    map: map
  });

  streetView.setPosition(pos);
}
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDf8skGR8RqBL3eVy1i8Euk6S424fvEsco&callback=initMaps">
</script>

</body>
</html>
