<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Torreon Traffic Incidents</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f7f7f7; }
  h1 { text-align:center; }
  #chart-container { width:100%; overflow-x:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
  svg { display:block; }
  .bar { fill:#69b3a2; cursor:pointer; }
  .bar:hover { fill:orange; }
  .x-axis text { font-size:12px; }
  .y-axis text { font-size:12px; }
</style>
</head>
<body>

<h1>Torreon Traffic Incidents</h1>
<div id="chart-container"></div>

<script>
const API_KEY = "YOUR_API_KEY"; // replace with your Google Maps API key

function renderChart() {
  d3.select("#chart-container").selectAll("*").remove();

  Promise.all([
    d3.csv("https://paco-stack-crimson.github.io/torreon-incidents/incidentes.csv"),
    d3.json("https://paco-stack-crimson.github.io/torreon-incidents/datos.json")
  ]).then(([trafficData, intersectionsData]) => {
    trafficData = trafficData.filter(d => d.Crucero && d.total_incidentes);
    trafficData.forEach(d => d.total_incidentes = +d.total_incidentes);

    const margin = {top:20,right:20,bottom:180,left:60};
    const containerWidth = document.getElementById("chart-container").clientWidth;
    const height = 450 - margin.top - margin.bottom;

    const minBarWidth = 40;
    const chartWidth = Math.max(containerWidth, trafficData.length * minBarWidth);

    const svg = d3.select("#chart-container")
      .append("svg")
      .attr("width", chartWidth + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleBand()
      .domain(trafficData.map(d=>d.Crucero))
      .range([0, chartWidth])
      .padding(0.2);

    const y = d3.scaleLinear()
      .domain([0,d3.max(trafficData,d=>d.total_incidentes)]).nice()
      .range([height,0]);

    svg.append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x))
      .selectAll("text")
        .attr("transform","rotate(-60)")
        .style("text-anchor","end");

    svg.append("g").call(d3.axisLeft(y));

    svg.selectAll(".bar")
      .data(trafficData)
      .enter()
      .append("rect")
        .attr("class","bar")
        .attr("x", d=>x(d.Crucero))
        .attr("y", d=>y(d.total_incidentes))
        .attr("width", x.bandwidth())
        .attr("height", d=>height - y(d.total_incidentes))
        .on("mouseover", (event,d)=>{
          const match = intersectionsData.find(i=>i.cruce===d.Crucero);
          if(match){
            const streetViewUrl = `https://maps.googleapis.com/maps/api/streetview?size=600x400&location=${match.latitude},${match.longitude}&key=${API_KEY}`;
            d3.select("#chart-container").append("div")
              .attr("class","tooltip")
              .html(`<h3>${match.cruce}</h3><p>Total: ${match.incidents}</p><p>Semaforizado: ${match.semaforizado}</p><img src="${streetViewUrl}">`)
              .style("position","absolute")
              .style("top",event.pageY+"px")
              .style("left",event.pageX+"px")
              .style("background","#fff")
              .style("padding","10px")
              .style("border","1px solid #ccc")
              .style("box-shadow","0 2px 8px rgba(0,0,0,0.2)");
          }
        })
        .on("mouseout", ()=>d3.selectAll(".tooltip").remove());

    svg.selectAll(".label")
      .data(trafficData)
      .enter()
      .append("text")
        .attr("x", d=>x(d.Crucero)+x.bandwidth()/2)
        .attr("y", d=>y(d.total_incidentes)-5)
        .attr("text-anchor","middle")
        .text(d=>d.total_incidentes);
  });
}

renderChart();
window.addEventListener("resize", renderChart);
</script>

</body>
</html>
